package com.rarible.protocol.order.listener.service.order

import com.rarible.protocol.order.core.model.RawOpenSeaOrder
import com.rarible.protocol.order.core.repository.order.OpenSeaOrderRepository
import com.rarible.protocol.order.listener.integration.AbstractIntegrationTest
import com.rarible.protocol.order.listener.integration.IntegrationTest
import io.daonomic.rpc.domain.Word
import kotlinx.coroutines.flow.collect
import kotlinx.coroutines.runBlocking
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired

@IntegrationTest
internal class LoadOpenSeaOrdersTaskHandlerTest : AbstractIntegrationTest() {
    @Autowired
    private lateinit var openSeaOrderRepository: OpenSeaOrderRepository

    @Autowired
    private lateinit var handler: LoadOpenSeaOrdersTaskHandler

    @Test
    fun testOpenSeaLoader() = runBlocking<Unit> {
        val raw1 = RawOpenSeaOrder(
            id = "1",
            value = "{\"id\":1821578589,\"asset\":{\"id\":83344011,\"token_id\":\"1222\",\"num_sales\":0,\"background_color\":null,\"image_url\":\"https://lh3.googleusercontent.com/jR5MV4GYfD6VaM2J5ab-2Qw4yRYdSR4COORcq2rpGsgQQmFJ-1Qg8UvRmccLnVRpciY76FrmHHMbSRatC5Yp7zTxsPvA0ebhVys0ZQ\",\"image_preview_url\":\"https://lh3.googleusercontent.com/jR5MV4GYfD6VaM2J5ab-2Qw4yRYdSR4COORcq2rpGsgQQmFJ-1Qg8UvRmccLnVRpciY76FrmHHMbSRatC5Yp7zTxsPvA0ebhVys0ZQ=s250\",\"image_thumbnail_url\":\"https://lh3.googleusercontent.com/jR5MV4GYfD6VaM2J5ab-2Qw4yRYdSR4COORcq2rpGsgQQmFJ-1Qg8UvRmccLnVRpciY76FrmHHMbSRatC5Yp7zTxsPvA0ebhVys0ZQ=s128\",\"image_original_url\":\"http://thedivine.vercel.app/image?id=1222\",\"animation_url\":null,\"animation_original_url\":null,\"name\":\"Druid Tel Yekara - Divine #1222\",\"description\":null,\"external_link\":null,\"asset_contract\":{\"address\":\"0xa3c2e31ad437742173706578748a223dda95f019\",\"asset_contract_type\":\"non-fungible\",\"created_date\":\"2021-10-22T00:50:41.547145\",\"name\":\"The Divine\",\"nft_version\":\"3.0\",\"opensea_version\":null,\"owner\":99645357,\"schema_name\":\"ERC721\",\"symbol\":\"DIVI\",\"total_supply\":\"0\",\"description\":\"The Divine is a collection of 4,444 hand-drawn, cosmic, angelic warriors that protect and nurture all that is good in the observable universe of their realm.\\n\\nThey are guided and created by the omnivalent Arc and reside in The Heavens. From The Fire, the dark world below The Heavens, demonic spawns arose to fight and overtake The Arc. Ultimately, The Fire failed, but this left a tainted mark on The Arc and The Heavens; that wouldn't be the last fight.\\n\\nEach Divine NFT holder will be apart of this fight as we prepare for the next Eradication.\\n\\nVisit https://divinenft.io website for more details or our Discord.\",\"external_link\":\"https://divinenft.io/\",\"image_url\":\"https://lh3.googleusercontent.com/mApsKBo45BzL4FIefxgfJ49jI5CJecPxVeQUF1CVfnTRvAsuHK80IcKlmjen8Nb5sgKjLB2oVJeI9CU3345E31AY5Vi7U1yiU5lN=s120\",\"default_to_fiat\":false,\"dev_buyer_fee_basis_points\":0,\"dev_seller_fee_basis_points\":500,\"only_proxied_transfers\":false,\"opensea_buyer_fee_basis_points\":0,\"opensea_seller_fee_basis_points\":250,\"buyer_fee_basis_points\":0,\"seller_fee_basis_points\":750,\"payout_address\":\"0x9de208d07d60a0983b862344a90ea769af3c231c\"},\"permalink\":\"https://opensea.io/assets/0xa3c2e31ad437742173706578748a223dda95f019/1222\",\"collection\":{\"banner_image_url\":\"https://lh3.googleusercontent.com/J_8NKKTrJNgxe_oNnvCHBqzziimaSCnnloggz1U7LLnrbGgVjj3PY-Eyr8XvOxmc8tk-epa2_vBOmdXeEp9KbVWfq7SpcOYKWNEe4Q=s2500\",\"chat_url\":null,\"created_date\":\"2021-10-22T01:15:54.209163\",\"default_to_fiat\":false,\"description\":\"The Divine is a collection of 4,444 hand-drawn, cosmic, angelic warriors that protect and nurture all that is good in the observable universe of their realm.\\n\\nThey are guided and created by the omnivalent Arc and reside in The Heavens. From The Fire, the dark world below The Heavens, demonic spawns arose to fight and overtake The Arc. Ultimately, The Fire failed, but this left a tainted mark on The Arc and The Heavens; that wouldn't be the last fight.\\n\\nEach Divine NFT holder will be apart of this fight as we prepare for the next Eradication.\\n\\nVisit https://divinenft.io website for more details or our Discord.\",\"dev_buyer_fee_basis_points\":\"0\",\"dev_seller_fee_basis_points\":\"500\",\"discord_url\":\"https://discord.gg/the-divine\",\"display_data\":{\"card_display_style\":\"contain\"},\"external_url\":\"https://divinenft.io/\",\"featured\":false,\"featured_image_url\":\"https://lh3.googleusercontent.com/mD7RAzIlqeLy1viFuyiVJ_2dIUZSbRu512QqurYqIJZHd5zpxADyF_Yt24ELvbXkdDHIP9lv5PSC9gHMZSSNjLLgkOZYKTjEoJ8KHNQ=s300\",\"hidden\":false,\"safelist_request_status\":\"not_requested\",\"image_url\":\"https://lh3.googleusercontent.com/mApsKBo45BzL4FIefxgfJ49jI5CJecPxVeQUF1CVfnTRvAsuHK80IcKlmjen8Nb5sgKjLB2oVJeI9CU3345E31AY5Vi7U1yiU5lN=s120\",\"is_subject_to_whitelist\":false,\"large_image_url\":\"https://lh3.googleusercontent.com/mD7RAzIlqeLy1viFuyiVJ_2dIUZSbRu512QqurYqIJZHd5zpxADyF_Yt24ELvbXkdDHIP9lv5PSC9gHMZSSNjLLgkOZYKTjEoJ8KHNQ=s300\",\"medium_username\":null,\"name\":\"The Divine NFT\",\"only_proxied_transfers\":false,\"opensea_buyer_fee_basis_points\":\"0\",\"opensea_seller_fee_basis_points\":\"250\",\"payout_address\":\"0x9de208d07d60a0983b862344a90ea769af3c231c\",\"require_email\":false,\"short_description\":null,\"slug\":\"the-divine-nft\",\"telegram_url\":null,\"twitter_username\":\"thedivinenft\",\"instagram_username\":null,\"wiki_url\":null},\"decimals\":0,\"token_metadata\":\"https://thedivine.vercel.app/metadata?id=1222\",\"owner\":{\"user\":{\"username\":\"Lunaa0677\"},\"profile_img_url\":\"https://storage.googleapis.com/opensea-static/opensea-profile/21.png\",\"address\":\"0x5c0b99763f444ba828dd4346bde3c26fdc04f473\",\"config\":\"\"}},\"asset_bundle\":null,\"created_date\":\"2021-12-02T15:52:19.892902\",\"closing_date\":\"2022-06-02T14:51:59\",\"closing_extendable\":false,\"expiration_time\":1654181519,\"listing_time\":1638460231,\"order_hash\":\"0x616560edcdcba0ea425c356a2dca850a62e28489a717f56cea6d819fd230b768\",\"metadata\":{\"asset\":{\"id\":\"1222\",\"address\":\"0xa3c2e31ad437742173706578748a223dda95f019\"},\"schema\":\"ERC721\"},\"exchange\":\"0x7be8076f4ea4a4ad08075c2508e481d6c946d12b\",\"maker\":{\"user\":{\"username\":\"Lunaa0677\"},\"profile_img_url\":\"https://storage.googleapis.com/opensea-static/opensea-profile/21.png\",\"address\":\"0x5c0b99763f444ba828dd4346bde3c26fdc04f473\",\"config\":\"\"},\"taker\":{\"user\":{\"username\":\"NullAddress\"},\"profile_img_url\":\"https://storage.googleapis.com/opensea-static/opensea-profile/1.png\",\"address\":\"0x0000000000000000000000000000000000000000\",\"config\":\"\"},\"current_price\":\"1000000000000000000.000000000\",\"current_bounty\":\"10000000000000000\",\"bounty_multiple\":\"0.01\",\"maker_relayer_fee\":\"750\",\"taker_relayer_fee\":\"0\",\"maker_protocol_fee\":\"0\",\"taker_protocol_fee\":\"0\",\"maker_referrer_fee\":\"0\",\"fee_recipient\":{\"user\":{\"username\":\"OS-Wallet\"},\"profile_img_url\":\"https://storage.googleapis.com/opensea-static/opensea-profile/28.png\",\"address\":\"0x5b3256965e7c3cf26e11fcaf296dfc8807c01073\",\"config\":\"verified\"},\"fee_method\":1,\"side\":1,\"sale_kind\":0,\"target\":\"0xa3c2e31ad437742173706578748a223dda95f019\",\"how_to_call\":0,\"calldata\":\"0x23b872dd0000000000000000000000005c0b99763f444ba828dd4346bde3c26fdc04f473000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004c6\",\"replacement_pattern\":\"0x000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000\",\"static_target\":\"0x0000000000000000000000000000000000000000\",\"static_extradata\":\"0x\",\"payment_token\":\"0x0000000000000000000000000000000000000000\",\"payment_token_contract\":{\"id\":1,\"symbol\":\"ETH\",\"address\":\"0x0000000000000000000000000000000000000000\",\"image_url\":\"https://storage.opensea.io/files/6f8e2979d428180222796ff4a33ab929.svg\",\"name\":\"Ether\",\"decimals\":18,\"eth_price\":\"1.000000000000000\",\"usd_price\":\"4529.239999999999782000\"},\"base_price\":\"1000000000000000000\",\"extra\":\"0\",\"quantity\":\"1\",\"salt\":\"39606639026444883807583802669428500965161230285481455708253835906333360087263\",\"v\":28,\"r\":\"0x31c1f3f714a4884571ce798fece28775773097b872873cd4bcc43f870cc70add\",\"s\":\"0x598fa618026e0ed3453cb54f577cc1974935fbde374533bf1347a2e9092160d5\",\"approved_on_chain\":false,\"cancelled\":false,\"finalized\":false,\"marked_invalid\":false,\"prefixed_hash\":\"0x5a3c55b3337b0ed394a483524e0a4b390f9e14d9e987f9dce3c0ea19bc605637\"}"
        )
        openSeaOrderRepository.save(raw1)

        handler.runLongTask(null, "").collect()

        assertThat(orderRepository.findById(Word.apply("0x616560edcdcba0ea425c356a2dca850a62e28489a717f56cea6d819fd230b768"))).isNotNull
    }
}
